---
 - hosts: all

   tasks:
   - name: Adiciona variaveis
     include_vars: "./vars.yml"

   - name: DOWNLOAD REPOSITORIO ZABBIX 6
     when: ( ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat' ) and ansible_distribution_version > '6' < 7
     get_url: url=https://repo.zabbix.com/zabbix/3.5/rhel/6/x86_64/zabbix-release-3.5-1.el6.noarch.rpm dest=/tmp/zabbix-release-3.5-1.el6.noarch.rpm mode=0777

   - name: INSTALANDO REPOSITORIO ZABBIX VERSAO 6
     when: ( ansible_distribution == "CentOS" or ansible_distribution == 'RedHat' ) and ansible_distribution_version > '6' < 7
     yum: name=/tmp/zabbix-release-3.5-1.el6.noarch.rpm state=present

   - name: INSTALANDO AGENTE VERSAO 6
     when: ( ansible_distribution == "CentOS" or ansible_distribution == 'RedHat' ) and ansible_distribution_version > '6' < 7
     yum: name=zabbix-agent state=latest

   - name: DOWNLOAD REPOSITORIO ZABBIX 7
     when: ( ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat' ) and ansible_distribution_version > 7
     get_url: url=https://repo.zabbix.com/zabbix/3.5/rhel/7/x86_64/zabbix-release-3.5-1.el7.noarch.rpm dest=/tmp/zabbix-release-3.5-1.el7.noarch.rpm mode=0777

   - name: INSTALANDO REPOSITORIO ZABBIX VERSAO 7
     when: ( ansible_distribution == "CentOS" or ansible_distribution == 'RedHat' ) and ansible_distribution_version > 7
     yum: name=/tmp/zabbix-release-3.5-1.el7.noarch.rpm state=present

   - name: INSTALANDO AGENTE VERSAO 7
     when: ( ansible_distribution == "CentOS" or ansible_distribution == 'RedHat' ) and ansible_distribution_version > 7
     yum: name=zabbix-agent state=latest

################################################

   - name: COPIANDO o AGENT CONFIG
     template: src=./files/zabbix_agentd.conf.j2 dest=/etc/zabbix_agentd.conf owner=root group=root mode=0644 backup=yes
     register: result

#   - name: Set hostname on conf file
#     lineinfile:
#      dest: /etc/zabbix_agentd.conf
#      regexp: ^Hostname=.*
#      insertafter: ^# Hostname=
#      line: Hostname={{ ansible_hostname }}
#
#   - name: Set hostname on conf file
#     lineinfile:
#      dest: /etc/zabbix_agentd.conf
#      regexp: ^Server=.*
#      insertafter: ^# Server=
#      line: Server={{ zserver }}
#
#   - name: Set hostname on conf file
#     lineinfile:
#      dest: /etc/zabbix_agentd.conf
#      regexp: ^ServerActive=.*
#      insertafter: ^# ServerActive=
#      line: ServerActive={{ zserver }}

   - name: REINICIANDO AGENTE ZABBIX
     service: name=zabbix-agent state=restarted
     when: result is changed

